# Makefile for MPIP	-*-Makefile-*-
# Copyright (C) 2001 Jeffrey Vetter vetter3@llnl.gov
# $Header$

srcdir=@srcdir@
VPATH = $(srcdir)

include Defs.mak

TARGET	= libmpiP.a

default: ${TARGET} ${FORTRAN_TARGET} ${DEMANGLE_TARGET}

all: ${TARGET} ${FORTRAN_TARGET} ${DEMANGLE_TARGET} test
	@echo All done.

SRCS =	diag_msgs.c \
	hash.c \
	glob.c \
	wrappers.c \
	wrappers_special.c \
	mpiPi.c \
	util.c \
	lookup.c \
	pc_lookup.c \
	report.c \
	pcontrol.c

ifeq ($(F77_VENDOR), Intel)
  SRCS += get_fortran_arg.f
endif

OBJS = $(SRCS:.c=.o)
OBJS := $(OBJS:.f=.o)


${TARGET}: ${OBJS} TAGS
	${AR} ruv $@ ${OBJS}
	${RANLIB} $@

${FORTRAN_TARGET}: remake_util ${OBJS} TAGS
	${AR} ruv $@ ${OBJS}
	${RANLIB} $@
	rm -f util.o

${DEMANGLE_TARGET}: remake_lookup ${OBJS} TAGS
	${AR} ruv $@ ${OBJS}
	${RANLIB} $@
	rm -f pc_lookup.o

.PHONY: remake_util remake_lookup

remake_util: CPPFLAGS += ${FORTRAN_FLAG}
remake_util:
	rm util.o
	$(MAKE) util.o CPPFLAGS='${CPPFLAGS}'

remake_lookup: CPPFLAGS += ${DEMANGLE_FLAG}
remake_lookup:
	rm pc_lookup.o
	$(MAKE) pc_lookup.o CPPFLAGS='${CPPFLAGS}'
	$(MAKE) util.o 

TAGS: ${SRCS}
	etags $^

test:
	$(MAKE) -C testing

clean::
	rm -f TAGS tags
	$(MAKE) -C testing clean

include $(srcdir)/Rules.mak

wrappers.c symbols.h lookup.c mpiPi_def.h: mpi.protos.txt make-wrappers.py
	$(PYTHON) $(srcdir)/make-wrappers.py --f77symbol $(F77_SYMBOLS) $^

${OBJS}: mpiPi_def.h

clean::
	rm -f wrappers.c symbols.h lookup.c mpiPi_def.h

MPIINC	= -I/usr/lpp/ppe.poe/include
lint: ${SRCS}
	gcc -Wall -Dlint ${CFLAGS} ${CPPFLAGS} ${MPIINC} -c ${SRCS}

distclean: clean
	rm -f Makefile Defs.mak Check.mak config.log config.status lookup.c mpiPconfig.h mpiPi_def.h symbols.h wrappers.c testing/Makefile libmpiP*

include Check.mak

##### EOF
