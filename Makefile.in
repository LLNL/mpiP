# Makefile for MPIP	-*-Makefile-*-
# Copyright (C) 2001 Jeffrey Vetter vetter3@llnl.gov
# $Header$

srcdir=@srcdir@
VPATH = $(srcdir)

include Defs.mak

MPIP_TARGET	= libmpiP.a

default: ${MPIP_TARGET} ${FORTRAN_TARGET} ${DEMANGLE_TARGET}

all: ${MPIP_TARGET} ${FORTRAN_TARGET} ${DEMANGLE_TARGET} test
	@echo All done.

SRCS =	diag_msgs.c \
	mpiP-hash.c \
	glob.c \
	wrappers.c \
	wrappers_special.c \
	mpiPi.c \
	util.c \
	lookup.c \
	pc_lookup.c \
	report.c \
	pcontrol.c \
	mpiP-API.c

USE_GETARG = @USE_GETARG@

OBJS = $(SRCS:.c=.o)
FOBJS = $(OBJS)

ifeq ($(USE_GETARG),true)
  FOBJS += get_fortran_arg.o
clean::
	rm -f get_fortran_arg.o
endif


${MPIP_TARGET}: ${OBJS} TAGS
	${AR} ruv $@ ${OBJS}
	${RANLIB} $@

${FORTRAN_TARGET}: remake_util ${FOBJS} TAGS
	${AR} ruv $@ ${FOBJS}
	${RANLIB} $@
	rm -f util.o

${DEMANGLE_TARGET}: remake_lookup ${OBJS} TAGS
	${AR} ruv $@ ${OBJS}
	${RANLIB} $@
	rm -f pc_lookup.o

.PHONY: remake_util remake_lookup

remake_util: CPPFLAGS += ${FORTRAN_FLAG}
remake_util:
	rm util.o
	$(MAKE) util.o CPPFLAGS='${CPPFLAGS}'

remake_lookup: CPPFLAGS += ${DEMANGLE_FLAG}
remake_lookup:
	rm pc_lookup.o
	$(MAKE) pc_lookup.o CPPFLAGS='${CPPFLAGS}'
	$(MAKE) util.o 

add_binutils_objs:
	-mkdir mpip_temp_obj_dir
	cd mpip_temp_obj_dir; \
	ar -x ${BIN_TYPE_FLAG} ${BINUTILS_DIR}/lib/libbfd.a ; \
	ar -x ${BIN_TYPE_FLAG} ${BINUTILS_DIR}/lib/libiberty.a ; \
	ar -x ${BIN_TYPE_FLAG} ${BINUTILS_DIR}/lib/libintl.a ; \
	ar -q ${BIN_TYPE_FLAG} ../${MPIP_TARGET} *.o ; \
	if [ "${FORTRAN_TARGET}" ]; then \
	  ar -q ${BIN_TYPE_FLAG} ../${FORTRAN_TARGET} *.o ; fi ; \
	if [ "${DEMANGLE_TARGET}" ]; then \
	  ar -q ${BIN_TYPE_FLAG} ../${DEMANGLE_TARGET} *.o ; fi
	rm -rf mpip_temp_obj_dir

add_libunwind_objs:
	-mkdir mpip_temp_obj_dir
	cd mpip_temp_obj_dir ; \
	ar -x ${BIN_TYPE_FLAG} /usr/lib/libunwind.a ; \
	ar -q ${BIN_TYPE_FLAG} ../${MPIP_TARGET} *.o ; \
	if [ "${FORTRAN_TARGET}" ]; then \
	  ar -q ${BIN_TYPE_FLAG} ../${FORTRAN_TARGET} *.o ; fi ; \
	if [ "${DEMANGLE_TARGET}" ]; then \
	  ar -q ${BIN_TYPE_FLAG} ../${DEMANGLE_TARGET} *.o ; fi
	rm -rf mpip_temp_obj_dir

TAGS: ${SRCS}
	etags $^

test:
	$(MAKE) -C testing

clean::
	rm -f TAGS tags
	$(MAKE) -C testing clean

include $(srcdir)/Rules.mak

wrappers.c symbols.h lookup.c mpiPi_def.h: mpi.protos.txt make-wrappers.py
	$(PYTHON) $(srcdir)/make-wrappers.py --f77symbol $(F77_SYMBOLS) $^

${OBJS}: mpiPi_def.h

clean::
	rm -f wrappers.c symbols.h lookup.c mpiPi_def.h

clean::
	rm -f ${FORTRAN_TARGET} ${DEMANGLE_TARGET}

MPIINC	= -I/usr/lpp/ppe.poe/include
lint: ${SRCS}
	gcc -Wall -Dlint ${CFLAGS} ${CPPFLAGS} ${MPIINC} -c ${SRCS}

distclean: clean
	rm -f Makefile Defs.mak Check.mak config.log config.status lookup.c mpiPconfig.h mpiPi_def.h symbols.h wrappers.c testing/Makefile libmpiP*

include Check.mak

##### EOF
